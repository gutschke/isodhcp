.TH ISODHCP 8 "December 2025" "Linux" "System Administration"
.SH NAME
isodhcp \- Unnumbered DHCP Server with Client Isolation
.SH SYNOPSIS
.B isodhcp
[\fB\-i\fR \fIinterface\fR]
[\fB\-s\fR \fIserver_ip\fR]
[\fB\-p\fR \fIpool_cidr\fR]
[\fB\-d\fR \fIdns_server\fR]
[\fB\-t\fR \fIlease_time\fR]
[\fB\-f\fR \fIlease_file\fR]
[\fB\-\-static\fR \fImac=ip[,hostname][,compat][,masquerade]\fR]...
[\fB\-\-compat\-mac\fR \fImac\fR]...
[\fB\-\-compat\-oui\fR \fIprefix\fR]...
[\fB\-\-compat\-vendor\fR \fIstring\fR]...
[\fB\-\-masquerade\-mac\fR \fImac\fR]...
[\fB\-\-masquerade\-oui\fR \fIprefix\fR]...
[\fB\-\-masquerade\-vendor\fR \fIstring\fR]...
[\fB\-\-nft\-set\-isolated\fR \fIset_name\fR]
[\fB\-\-nft\-set\-compat\fR \fIset_name\fR]
[\fB\-\-nft\-set\-gateway\fR \fIset_name\fR]
[\fB\-\-nft\-set\-network\fR \fIset_name\fR]
[\fB\-\-nft\-set\-broadcast\fR \fIset_name\fR]
[\fB\-\-nft\-set\-subnet\fR \fIset_name\fR]...
[\fB\-\-hook\-file\fR \fIpath\fR]
[\fB\-\-isolation\fR \fI{on,off,system}\fR]
.SH DESCRIPTION
.B isodhcp
is a lightweight, specialized DHCP server designed for secure Linux
routers hosting Guest, IoT, or untrusted networks.

.PP
Unlike standard DHCP servers, \fBisodhcp\fR utilizes an "Unnumbered
Interface" architecture. It assigns clients a \fB/32\fR subnet mask
(255.255.255.255), forcing all traffic \- even traffic destined for
other devices on the same physical wire \- to route through the gateway.

.PP
Simultaneously, \fBisodhcp\fR interacts directly with the Linux kernel using
\fBnetlink\fR to inject explicit host routes for every connected client.
This combination allows the administrator to implement strict layer 3 client
isolation and granular firewalling (via \fBNFTables\fR) on the router,
effectively treating a shared Ethernet segment as a collection of
point-to-point links.

.PP
For legacy clients that lack support for point-to-point \fB/32\fR netmasks,
\fBisodhcp\fR can operate in a micro-segmentation mode that helps
with compatibility problems. For these clients, \fBisodhcp\fR dynamically
carves a \fB/30\fR subnet (4 IPs) out of the main pool. It assigns a secondary
alias IP to the router interface to serve as the gateway for that specific
client. The client sees a standard broadcast domain, but is effectively
isolated in its own tiny subnet.

.PP
Furthermore \fBisodhcp\fR can utilize source NAT'ing to make all traffic that
is directed towards a client look as if it originated from the gateway address
assigned to that client. This can help with restricted network implementations.

.PP
The daemon uses raw sockets (via \fBscapy\fR) to handle DHCP traffic, bypassing
standard UDP listeners. It includes built-in rate limiting to prevent DoS
attacks and manages lease persistence via a JSON file.

.SH OPTIONS
.TP
.B \-d \fIdns\fR, \fB\-\-dns\fR \fIdns\fR
The DNS server IP address to offer clients. If omitted, the server parses
\fI/etc/resolv.conf\fR (and systemd-resolved upstream configurations) to find a
valid IPv4 nameserver.

.TP
.B \-f \fIpath\fR, \fB\-\-lease-file\fR \fIpath\fR
Path to the JSON file where lease state is persisted. Defaults to
\fIdhcp_leases_{INTERFACE}.json\fR in the current working directory. The server writes to
this file on allocation, release, and shutdown. To minimize disk wear, renewals
are only written if the expiration time changes significantly.

.TP
.B \-i \fIinterface\fR, \fB\-\-interface\fR \fIinterface\fR
The network interface to listen on (e.g., \fIeth1\fR, \fIwlan0\fR). The server
binds specifically to this interface to avoid conflicts with other DHCP servers
on the host. Defaults to \fIguest\fR.

.TP
.B \-p \fIpool\fR, \fB\-\-pool\fR \fIpool\fR
The CIDR range of IPs to allocate (e.g., \fI10.100.0.0/24\fR). If omitted, the
server attempts to auto-detect the subnet configured on the interface.

.TP
.B \-s \fIserver_ip\fR, \fB\-\-server-ip\fR \fIserver_ip\fR
The IP address of the router (gateway). If omitted, the server attempts to
auto-detect the primary IP address assigned to the interface specified
by \fB\-i\fR.

.TP
.B \-t \fIseconds\fR, \fB\-\-lease-time\fR \fIseconds\fR
The duration of the DHCP lease in seconds. Defaults to \fI3600\fR (1 hour).

.TP
.B \-\-compat\-mac \fImac\fR
Treat the specified MAC address as a "legacy" client. Instead of receiving the
standard strict \fB/32\fR netmask (client isolation), this device will be
assigned a \fB/30\fR micro-segment with a netmask of \fB255.255.255.252\fR).
.br
Useful for older printers, embedded devices, or game consoles that refuse to
accept a gateway outside of their own subnet mask.
.br
Example: \fI\-\-compat\-mac 00:11:22:33:44:55\fR

.TP
.B \-\-compat\-oui \fIoui\fR
Treat any device whose MAC address starts with this 3-byte prefix
(Organizationally Unique Identifier) as a legacy client.
.br
The OUI format is \fIAA:BB:CC\fR. Case is insensitive.
.br
Example: \fI\-\-compat\-oui B8:27:EB\fR (Raspberry Pi Foundation)

.TP
.B \-\-compat\-vendor \fIstring\fR
Treat any device sending a DHCP Vendor Class Identifier (option 60) containing
this substring as a legacy client.
.br
Useful for broad classes of devices or operating systems known to struggle with
unnumbered interfaces.
.br
Example: \fI\-\-compat\-vendor "MSFT 5.0"\fR

.TP
.B \-\-masquerade\-mac \fImac\fR
The device with this MAC will have their traffic source NAT'd (SNAT) by the
router. Traffic destined for these clients will appear to originate from the
gateway IP itself, rather than the original sender.

.TP
.B \-\-masquerade\-oui \fIprefix\fR
Apply source NAT to any device whose MAC address starts with this
3-byte prefix.

.TP
.B \-\-masquerade\-vendor \fIprefix\fR
Apply source NAT to any device that matches this DHCP Vendor Class Identifier.

.TP
.B \-\-nft\-set\-isolated \fIname\fR
The daemon can populate named \fBNFTables\fR sets for integration with
firewall rules. Each option can only be given once and specifies an
optional name for a set (e.g., \fI"inet filter iso_clients"\fR). The set will
not be created if it doesn't already exist. \fB\-\-nft\-set\-isolated\fR names
the set for standard \fB/32\fR clients.
.TP
.B \-\-nft\-set\-compat \fIname\fR
Set for legacy \fB/30\fR clients.
.TP
.B \-\-nft\-set\-gateway \fIname\fR
Set for the dynamic gateway IPs created for \fB/30\fR blocks.
.TP
.B \-\-nft\-set\-network \fIname\fR
Set for the network addresses of \fB/30\fR blocks.
.TP
.B \-\-nft\-set\-broadcast \fIname\fR
Set for the broadcast addresses of \fB/30\fR blocks.
.TP
.B \-\-nft\-set\-subnet \fIname\fR
Set for the CIDR blocks of \fB/30\fR allocations. \fBNote:\fR This set must have
the \fBinterval\fR flag enabled in \fBNFTables\fR.
.TP
.B \-\-static \fImac=ip[,hostname][,compat][,masquerade]\fR
Map a MAC to a specific IP. Can be repeated.
.br
\fBhostname\fR: (Optional) string to log for this device.
.br
\fBcompat\fR: (Optional) flag to force this device into legacy or
compatibility mode.
.br
\fBmasquerade\fR: (Optional) enable source NAT for this client.
.br
.B Note:
For \fIcompat\fR entries, the IP must be the ".2" offset of a valid
\fB/30\fR block (e.g., .2, .6, .10). The server will reserve the entire 4-IP
block immediately at startup.
.br
Static entries are initialized immediately at startup. The server configures the
interface, routes, and firewall rules before the client even connects. These
addresses are permanently removed from the free pool.
.TP
.B \-\-hook\-file \fIpath\fR
Path to an executable script (e.g., shell or Python) that is invoked whenever a
lease is added or released. See \fBHOOK SCRIPT\fR below for details.
.TP
.B \-\-isolation \fI{on,off,system}\fR
In the vast majority of cases, the job of \fBisodhcp\fR is done as soon as it
sends all traffic through the level 3 router. Policy decisions are supposed to
be enforced by a third-party firewall. But sometimes, the situation is easy
enough that it only requires minimal firewall rules. In that case, the daemon
can be configured to actively block ("on") or actively allow ("off")
communication between clients. The default is "system", which leaves the
firewall unconfigured.

.SH HOOK SCRIPT
If \fB\-\-hook\-file\fR is specified, the server executes the script
asynchronously on lease changes.
.PP
\fBArguments:\fP
.br
$1 = \fBadd\fR or \fBdel\fR
.br
$2 = MAC Address
.br
$3 = IP Address
.br
$4 = Hostname (if available)

.PP
\fBEnvironment Variables:\fP
.TP
.B ISODHCP_PID
Process ID of the server.
.TP
.B ISODHCP_INTERFACE
The listening interface (e.g., \fIguest\fR).
.TP
.B ISODHCP_SERVER_IP
The router's main IP address.
.TP
.B ISODHCP_POOL_CIDR
The network used to allocate the dynamic pool of IP addresses.
.TP
.B ISODHCP_DNS
The DNS server advertised by the DHCP server.
.TP
.B ISODHCP_LEASE_FILE
The JSON file where the server persists its internal state.
.TP
.B ISODHCP_TOTAL_LEASES
Current count of active leases.
.TP
.B ISODHCP_FREE_IPS
Current unassigned IP addresses.
.TP
.B ISODHCP_ISOLATION
Current isolation mode. Can be "on", "off" or "system".
.TP
.B ISODHCP_MASQ
"1" if Masquerade is enabled for this client, else "0".
.TP
.B ISODHCP_COMPAT
"1" if legacy/compat mode is enabled, else "0".
.TP
.B ISODHCP_GATEWAY
The specific gateway IP assigned to this client (varies for /30 clients).
.TP
.B ISODHCP_NETMASK
The specific netmask for this client. Either "255.255.255.255"
or "255.255.255.252".
.TP
.B ISODHCP_SUBNET
The specific subnet assigned to this /30 client.

.SH SIGNALS
.TP
.B SIGINT, SIGTERM, SIGHUP
The server catches these signals to perform an orderly shutdown. It flushes the
current state of all leases to the JSON file before exiting.
.TP
.B SIGUSR1
Reload configuration state. The server will re-scan the in-memory leases and
re-apply all external system state:
.RS
.IP \[bu] 2
Refresh \fBNFTables\fR sets (add missing elements, but don't remove any
extraneous ones if present).
.IP \[bu] 2
Re-add missing IP aliases to the interface.
.IP \[bu] 2
Sync kernel routing table (restore missing /32 routes).
.RE

.SH EXAMPLES
.PP
\fB1. Auto-detected configuration (standard usage)\fP
.br
Start the server on \fIguest0\fR. The server IP and pool are derived from the
interface's system configuration:
.IP
.B isodhcp \-i guest0

.PP
\fB2. Manual override with static IPs\fP
.br
Manually specify the gateway and pool, and assign a static IP to a printer:
.IP
.B isodhcp \-i eth1 \-s 192.168.50.1 \-p 192.168.50.0/24 \-\-static 00:11:22:33:44:55=192.168.50.10,laserprinter

.PP
\fB3. High-turnover guest network\fP
.br
Set a short lease time (5 minutes) for a busy public Wi-Fi interface:
.IP
.B isodhcp \-i wlan0 \-\-lease-time 300

.PP
\fB4. Systemd service definition\fP
.br
A typical \fIExecStart\fR and \fIExecReload\fR line in a systemd unit file:
.IP
.B ExecStart=/usr/bin/python3 /opt/isodhcp/server.py \-\-interface eth1 \-\-lease-file /opt/isodhcp/leases.json
.IP
.B ExecReload=/bin/kill \-USR1 $MAINPID

.PP
\fB5. Handling legacy devices\fP
.br
Run the server with micro-segmentation for a specific printer, all
Raspberry Pis, and old Windows clients:
.IP
.B isodhcp \-i eth1 \-\-compat\-mac 00:11:22:33:44:55 \-\-compat\-oui B8:27:EB \-\-compat\-vendor "MSFT 5.0"

.PP
\fB6. Masquerading a specific device\fP
.br
Force a device with a specific MAC to be masqueraded behind the gateway IP:
.IP
.B isodhcp \-\-masquerade\-mac aa:bb:cc:dd:ee:ff

.PP
\fB7. Advanced hybrid configuration\fP
.br
Run on \fIguest0\fR. Treat Nintendo Switch (OUI \fI98:B6:E9\fR) and Windows XP
clients as legacy. Assign a static IP to a client that can't handle /32 routes.
Populate \fBNFTables\fR sets for firewalling:
.IP
.nf
isodhcp \-i guest0 \\
  \-\-compat\-oui 98:B6:E9 \\
  \-\-compat\-vendor "MSFT 5.0" \\
  \-\-static 00:11:22:33:44:55=192.168.2.6,compat,masquerade \\
  \-\-nft\-set\-isolated "inet filter client_iso" \\
  \-\-nft\-set\-compat "inet filter client_legacy" \\
  \-\-nft\-set\-gateway "inet filter local_gateways"
.fi

.PP
\fB2. Static legacy reservation\fP
.br
Assign a printer to 10.100.0.10. Force it to use a /30 subnet (occupying
10.100.0.8/30) because it doesn't support /32:
.IP
.B isodhcp \-\-static 00:11:22:33:44:55=10.100.0.10,printer,compat

.SH FILES
.TP
.I ./dhcp_leases_{INTERFACE}.json
The default location for lease persistence. Ensure the user running the daemon
has write permissions to this file (or directory).

.SH SECURITY & PERMISSIONS
To run \fBisodhcp\fR as an unprivileged user, the process requires the
following Linux capabilities:
.TP
.B CAP_NET_RAW
Required to open raw sockets for sending/receiving DHCP packets via Scapy.
.TP
.B CAP_NET_ADMIN
Required to modify the kernel routing table (adding/removing /32 routes via
\fBnetlink\fR).
.TP
.B CAP_NET_BIND_SERVICE
Required to bind to port 67 (optional, depending on implementation
details, but recommended).

.PP
In a systemd unit file, these can be assigned via:
.br
\fIAmbientCapabilities=CAP_NET_RAW CAP_NET_ADMIN CAP_NET_BIND_SERVICE\fR

.SH NFTABLES CONFIGURATION
To use the \fB\-\-nft\-set\-subnet\fR feature, the target set must be capable
of storing intervals (CIDRs). Example configuration in \fI/etc/nftables.conf\fR:

.nf
table inet filter {
    set iso_clients { type ipv4_addr; }
    set compat_subnets {
        type ipv4_addr
        flags interval
    }
}
.fi

.SH AVAHI / MDNS INTERACTION
By default, this server disables \fBPromiscuous Mode\fR on the raw socket to
prevent the OS from flagging a "link change" event. This prevents local mDNS
daemons (like Avahi) from flushing their cache every time the server restarts.

To ensure proper mDNS reflection between the isolated network and a trusted
network, ensure the router interface has a valid IP address within the pool
range (e.g., \fI10.100.0.1/24\fR), even though clients are assigned \fI/30\fR
and \fI/32\fR masks.

.SH SEE ALSO
.BR ip (8),
.BR nftables (8),
.BR avahi-daemon (8)
